<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profile - Fresh & Organic Milk</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f9faf9;
      margin: 0;
      padding: 0;
      color: #2d3748;
    }
    header {
      background-color: #38a169;
      color: white;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    header img.logo {
      height: 40px;
    }
    header h1 {
      font-size: 1.5rem;
      margin: 0;
    }
    .profile-container {
      max-width: 800px;
      margin: 2rem auto;
      background: white;
      border-radius: 8px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .profile-picture {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background-color: #c6f6d5;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: #276749;
      margin-bottom: 1rem;
    }
    h2.section-title {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
      border-bottom: 2px solid #38a169;
      padding-bottom: 0.25rem;
    }
    .user-info, .address-section, .subscription-section {
      margin-bottom: 2rem;
    }
    .field-label {
      font-weight: 600;
      margin-bottom: 0.25rem;
      display: block;
    }
    .field-value, input[type="text"] {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      font-size: 1rem;
      color: #2d3748;
    }
    input[type="text"]:disabled {
      background-color: #edf2f7;
      color: #4a5568;
    }
    .button-group {
      display: flex;
      gap: 1rem;
    }
    button {
      background-color: #38a169;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #2f855a;
    }
    button.cancel-btn {
      background-color: #a0aec0;
    }
    button.cancel-btn:hover {
      background-color: #718096;
    }
    .manage-subscription-btn {
      background-color: #3182ce;
    }
    .manage-subscription-btn:hover {
      background-color: #2b6cb0;
    }
    .remaining-days-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
    }
    .remaining-days-high {
      background-color: #c6f6d5;
      color: #276749;
    }
    .remaining-days-medium {
      background-color: #fef5e7;
      color: #c05621;
    }
    .remaining-days-low {
      background-color: #fed7d7;
      color: #c53030;
    }
    .remaining-days-expired {
      background-color: #e2e8f0;
      color: #4a5568;
    }
    footer {
      /* Remove conflicting footer styles to use standard bottom-nav */
    }
    
    /* Modal styles for pause confirmation */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    
    .modal-content h3 {
      margin-top: 0;
      color: #2d3748;
    }
    
    .modal-content p {
      margin: 1rem 0;
      color: #4a5568;
    }
    
    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 1.5rem;
    }
    
    .action-btn {
      padding: 0.5rem 1.5rem;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      transition: opacity 0.3s ease;
    }
    
    .action-btn:hover {
      opacity: 0.9;
    }
    
    @media (max-width: 600px) {
      .profile-container {
        margin: 1rem;
        padding: 1rem;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <header style="display: flex; justify-content: center; align-items: center; padding: 1rem 2rem; background-color: #38a169; color: white;">
    <img src="images/logo.jpg" alt="Fresh & Organic Milk Logo" class="logo" style="height: 50px;" />
  </header>

  <main class="profile-container">
    <div class="profile-picture" id="profilePicture" aria-label="User Profile Picture">
      <!-- Placeholder initials -->
      <span id="profileInitials">U</span>
    </div>

    <section class="user-info" aria-label="User Information">
      <h2 class="section-title">User Information</h2>
      <p><strong>Name:</strong> <span id="userName">User Name</span></p>
      <p><strong>Email:</strong> <span id="userEmail">user@example.com</span></p>
      <p>
        <strong>Address:</strong>
        <span id="userAddress">No address available</span>
        
      </p>
      <form id="editAddressForm" style="display:none; margin-top: 1rem;">
        <label for="editStreet" class="field-label">Street</label>
        <input type="text" id="editStreet" name="editStreet" placeholder="Street" />
        <label for="editCity" class="field-label">City</label>
        <input type="text" id="editCity" name="editCity" placeholder="City" />
        <label for="editState" class="field-label">State</label>
        <input type="text" id="editState" name="editState" placeholder="State" />
        <label for="editZip" class="field-label">Zip Code</label>
        <input type="text" id="editZip" name="editZip" placeholder="Zip Code" />
        <div class="button-group" style="margin-top: 0.5rem;">
          <button type="button" id="saveAddressBtn">Save</button>
          <button type="button" id="cancelEditAddressBtn" class="cancel-btn">Cancel</button>
        </div>
      </form>
    </section>

    <!-- Removed saved addresses section as per user request -->

    <section class="subscription-section" aria-label="Subscription Status">
      <h2 class="section-title">Subscription Status</h2>
      <div id="subscriptionDetails">
        <p><strong>Status:</strong> <span id="subscriptionStatus">No active subscription</span></p>
        <p id="subscriptionType" style="display:none;"><strong>Type:</strong> <span></span></p>
        <p id="subscriptionDuration" style="display:none;"><strong>Duration:</strong> <span></span></p>
        <p id="subscriptionStart" style="display:none;"><strong>Started:</strong> <span></span></p>
        <p id="subscriptionEnd" style="display:none;"><strong>Ends:</strong> <span></span></p>
        <p id="remainingDays" style="display:none;"><strong>Remaining Days:</strong> <span class="remaining-days-badge"></span></p>
      </div>
      <div class="button-group" style="margin-top: 0.5rem;">
        <button id="pauseSubscriptionBtn" class="manage-subscription-btn" style="display:none;">Pause Subscription</button>
        <button id="resumeSubscriptionBtn" class="manage-subscription-btn" style="display:none;">Resume Subscription</button>
        <button id="subscribeNowBtn" class="manage-subscription-btn" style="display:none;">Subscribe Now</button>
        <a href="subscription.html" class="manage-subscription-btn" style="text-decoration: none; display: none;">Manage Subscriptions</a>
      </div>
    </section>

    <div style="text-align:center; margin-top: 1rem;">
      <button id="logoutBtn" style="background-color:#e53e3e; color:white; border:none; padding:0.75rem 1.5rem; border-radius:4px; font-size:1rem; cursor:pointer;">Logout</button>
    </div>
  </main>

  <!-- Confirmation Modal for Pause -->
  <div id="pauseConfirmationModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3 id="modalTitle">Confirm Pause</h3>
      <p id="modalMessage">Are you sure you want to pause your subscription?</p>
      <div class="modal-actions">
        <button id="confirmPauseBtn" class="action-btn" style="background: #ffc107; color: #212529;">Confirm</button>
        <button id="cancelPauseBtn" class="action-btn" style="background: #6c757d; color: white;">Cancel</button>
      </div>
    </div>
  </div>

  <footer>
    <nav class="bottom-nav">
      <a href="index.html" class="nav-item">Home</a>
      <a href="cart.html" class="nav-item">cart</a>
      <a href="offers-final.html" class="nav-item">Offers</a>
      <a href="subscription.html" class="nav-item">Subscription</a>
      <a href="profile.html" class="nav-item active">Profile</a>
    </nav>
  </footer>

  <script>
    // JavaScript to handle address editing and subscription management
    document.addEventListener('DOMContentLoaded', () => {
      // Check if user is logged in by verifying userEmail in localStorage
      const userEmail = localStorage.getItem('userEmail');
      if (!userEmail) {
        alert('You must be logged in to view the profile page.');
        window.location.href = 'login.html';
        return;
      }

      // Removed saved addresses related elements as per user request
      // const savedAddressesList = document.getElementById('savedAddressesList');
      // const addNewAddressBtn = document.getElementById('addNewAddressBtn');
      // const newAddressForm = document.getElementById('newAddressForm');
      // const newAddressInput = document.getElementById('newAddressInput');
      // const newBuildingInput = document.getElementById('newBuildingInput');
      // const newFlatInput = document.getElementById('newFlatInput');
      // const saveNewAddressBtn = document.getElementById('saveNewAddressBtn');
      // const cancelNewAddressBtn = document.getElementById('cancelNewAddressBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const userNameSpan = document.getElementById('userName');
      const userEmailSpan = document.getElementById('userEmail');
      const profileInitialsSpan = document.getElementById('profileInitials');
      const userAddressSpan = document.getElementById('userAddress');
      const editAddressBtn = document.getElementById('editAddressBtn');
      const editAddressForm = document.getElementById('editAddressForm');
      const editStreetInput = document.getElementById('editStreet');
      const editCityInput = document.getElementById('editCity');
      const editStateInput = document.getElementById('editState');
      const editZipInput = document.getElementById('editZip');
      const saveAddressBtn = document.getElementById('saveAddressBtn');
      const cancelEditAddressBtn = document.getElementById('cancelEditAddressBtn');

      // Removed saved addresses related functions as per user request
      // function renderAddresses(addresses) {
      //   savedAddressesList.innerHTML = '';
      //   if (!Array.isArray(addresses) || addresses.length === 0) {
      //     savedAddressesList.innerHTML = '<li>No saved addresses found.</li>';
      //     return;
      //   }
      //   addresses.forEach(addr => {
      //     const li = document.createElement('li');
      //     li.textContent = `${addr.address}${addr.building_name ? ', ' + addr.building_name : ''}${addr.flat_number ? ', Flat ' + addr.flat_number : ''}`;
      //     savedAddressesList.appendChild(li);
      //   });
      // }

      // function fetchAddresses() {
      //   const username = localStorage.getItem('userEmail');
      //   if (!username) {
      //     savedAddressesList.innerHTML = '<li>Please log in to see saved addresses.</li>';
      //     return;
      //   }
      // fetch(`/api/user-addresses?username=${encodeURIComponent(username)}`)
      //     .then(res => {
      //       console.log('Fetch addresses response status:', res.status);
      //       if (!res.ok) throw new Error('Failed to fetch addresses');
      //       return res.json();
      //     })
      //     .then(data => {
      //       console.log('Fetched addresses data:', data);
      //       renderAddresses(data);
      //     })
      //     .catch(err => {
      //       console.error('Error fetching addresses:', err);
      //       savedAddressesList.innerHTML = '<li>Error loading addresses.</li>';
      //     });
      // }

      async function fetchUserProfile() {
        const username = localStorage.getItem('userEmail');
        if (!username) {
          alert('Please log in to view your profile');
          window.location.href = 'login.html';
          return;
        }

        try {
          const response = await fetch(`/api/profile?username=${encodeURIComponent(username)}`);
          
          if (!response.ok) {
            const errorData = await response.json();
            
            if (response.status === 404) {
              // User doesn't exist - offer registration
              if (confirm('User profile not found. Would you like to register a new account?')) {
                window.location.href = 'login.html#register';
              } else {
                window.location.href = 'login.html';
              }
              return;
            }
            
            if (response.status === 400) {
              alert('Invalid request: ' + (errorData.message || 'Please check your login status'));
              window.location.href = 'login.html';
              return;
            }
            
            throw new Error(errorData.message || 'Failed to load profile');
          }

          const data = await response.json();
          console.log('Fetched profile data:', data);
          
          // Update UI with user data
          userNameSpan.textContent = data.name || 'User Name';
          userEmailSpan.textContent = data.email || username;
          profileInitialsSpan.textContent = data.name ? data.name.charAt(0).toUpperCase() : 'U';
          
          // Format address display
          // Prefer subscription address if available
          let addressToDisplay = '';
          if (data.subscription_address) {
            addressToDisplay = data.subscription_address;
            if (data.subscription_building_name) {
              addressToDisplay += ', ' + data.subscription_building_name;
            }
            if (data.subscription_flat_number) {
              addressToDisplay += ', Flat ' + data.subscription_flat_number;
            }
          } else {
            const addressParts = [data.street, data.city, data.state, data.zip].filter(part => part && part.trim());
            addressToDisplay = addressParts.length > 0 ? addressParts.join(', ') : 'No address available';
          }
          userAddressSpan.textContent = addressToDisplay;

          // Pre-fill edit form inputs
          editStreetInput.value = data.street || '';
          editCityInput.value = data.city || '';
          editStateInput.value = data.state || '';
          editZipInput.value = data.zip || '';

          // Show profile completion notice if incomplete
          if (!data.profile_complete) {
            console.log('Profile incomplete - consider showing completion prompt');
          }

        } catch (err) {
          console.error('Error loading profile:', err);
          alert('Error loading user profile: ' + err.message + '\n\nPlease try refreshing the page or logging in again.');
        }
      }

      // Removed saved addresses related event listeners as per user request
      // addNewAddressBtn.addEventListener('click', () => {
      //   newAddressForm.style.display = 'block';
      //   addNewAddressBtn.style.display = 'none';
      // });

if(editAddressBtn) {
  editAddressBtn.addEventListener('click', () => {
    editAddressForm.style.display = 'block';
    editAddressBtn.style.display = 'none';
    userAddressSpan.style.display = 'none';
  });
}

if(cancelEditAddressBtn) {
  cancelEditAddressBtn.addEventListener('click', () => {
    editAddressForm.style.display = 'none';
    editAddressBtn.style.display = 'inline-block';
    userAddressSpan.style.display = 'inline';
  });
}

if(saveAddressBtn) {
  saveAddressBtn.addEventListener('click', () => {
    const street = editStreetInput.value.trim();
    const city = editCityInput.value.trim();
    const state = editStateInput.value.trim();
    const zip = editZipInput.value.trim();
    if (!street || !city || !state || !zip) {
      alert('All address fields are required');
      return;
    }
    const username = localStorage.getItem('userEmail');
    if (!username) {
      alert('User not logged in');
      return;
    }
    
    // Use the correct endpoint and method
    fetch(`/api/users/${encodeURIComponent(username)}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        name: userNameSpan.textContent,
        phone: userEmailSpan.textContent.substring(0, 20), // Limit phone to 20 chars
        email: userEmailSpan.textContent,
        street: street,
        city: city,
        state: state,
        zip: zip
      })
    })
      .then(async res => {
        if (!res.ok) {
          const errorText = await res.text();
          console.error('Failed to update address:', res.status, errorText);
          throw new Error(`Failed to update address: ${res.status} ${errorText}`);
        }
        return res.json();
      })
      .then(() => {
        alert('Address updated successfully');
        editAddressForm.style.display = 'none';
        editAddressBtn.style.display = 'inline-block';
        userAddressSpan.style.display = 'inline';
        fetchUserProfile();
      })
      .catch(err => {
        console.error('Error updating address:', err);
        alert('Error updating address');
      });
  });
}

      // cancelNewAddressBtn.addEventListener('click', () => {
      //   newAddressForm.style.display = 'none';
      //   addNewAddressBtn.style.display = 'inline-block';
      //   newAddressInput.value = '';
      //   newBuildingInput.value = '';
      //   newFlatInput.value = '';
      // });

      // saveNewAddressBtn.addEventListener('click', () => {
      //   const address = newAddressInput.value.trim();
      //   const building_name = newBuildingInput.value.trim();
      //   const flat_number = newFlatInput.value.trim();
      //   if (!address) {
      //     alert('Address is required');
      //     return;
      //   }
      //   const username = localStorage.getItem('userEmail');
      //   if (!username) {
      //     alert('Please log in to save addresses');
      //     return;
      //   }
      //   // For simplicity, latitude and longitude are not captured here
      //   fetch('/api/user-location', {
      //     method: 'POST',
      //     headers: { 'Content-Type': 'application/json' },
      //     body: JSON.stringify({ username, address, building_name, flat_number, latitude: 0, longitude: 0 })
      //   })
      //     .then(res => {
      //       console.log('Save address response status:', res.status);
      //       if (!res.ok) throw new Error('Failed to save address');
      //       return res.json();
      //     })
      //     .then(() => {
      //       alert('Address saved successfully');
      //       newAddressForm.style.display = 'none';
      //       addNewAddressBtn.style.display = 'inline-block';
      //       newAddressInput.value = '';
      //       newBuildingInput.value = '';
      //       newFlatInput.value = '';
      //       fetchAddresses();
      //     })
      //     .catch(err => {
      //       console.error('Error saving address:', err);
      //       alert('Error saving address');
      //     });
      // });

      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('loggedIn');
        localStorage.removeItem('userName');
        localStorage.removeItem('userEmail');
        window.location.href = 'login.html';
      });

      // Add event listeners for pause/resume buttons
      const pauseSubscriptionBtn = document.getElementById('pauseSubscriptionBtn');
      const resumeSubscriptionBtn = document.getElementById('resumeSubscriptionBtn');
      
      pauseSubscriptionBtn.addEventListener('click', () => {
        pauseResumeSubscription('pause');
      });
      
      resumeSubscriptionBtn.addEventListener('click', () => {
        pauseResumeSubscription('resume');
      });

      // Removed fetchAddresses call as saved addresses feature is removed
      fetchUserProfile();
      fetchSubscriptionDetails();

      function fetchSubscriptionDetails() {
        const username = localStorage.getItem('userEmail');
        if (!username) {
          return;
        }

        fetch(`/api/subscriptions/remaining/${encodeURIComponent(username)}`)
          .then(res => {
            if (!res.ok) {
              throw new Error('Failed to fetch subscription details');
            }
            return res.json();
          })
          .then(data => {
            const subscriptionStatus = document.getElementById('subscriptionStatus');
            const subscriptionType = document.getElementById('subscriptionType');
            const subscriptionDuration = document.getElementById('subscriptionDuration');
            const subscriptionStart = document.getElementById('subscriptionStart');
            const subscriptionEnd = document.getElementById('subscriptionEnd');
            const remainingDays = document.getElementById('remainingDays');
            const pauseSubscriptionBtn = document.getElementById('pauseSubscriptionBtn');
            const resumeSubscriptionBtn = document.getElementById('resumeSubscriptionBtn');
            const subscribeNowBtn = document.getElementById('subscribeNowBtn');
            const manageSubscriptionsLink = document.querySelector('a[href="manage-subscription.html"]');

            if (data.hasActiveSubscription && data.subscription) {
              const subscription = data.subscription;
              
          // Update subscription status
          subscriptionStatus.textContent = subscription.status === 'active' ? 'Active' : 
                                          subscription.status === 'inactive' ? 'Paused' : 
                                          subscription.status === 'cancelled' ? 'Cancelled' : 'Expired';
              
              // Update subscription details
              subscriptionType.querySelector('span').textContent = subscription.subscription_type;
              subscriptionDuration.querySelector('span').textContent = subscription.duration;
              subscriptionStart.querySelector('span').textContent = new Date(subscription.created_at).toLocaleDateString();
              subscriptionEnd.querySelector('span').textContent = subscription.end_date;
              
              // Update remaining days
              const remainingDaysSpan = remainingDays.querySelector('.remaining-days-badge');
              remainingDaysSpan.textContent = `${subscription.remaining_days} days`;
              
              // Add color coding based on remaining days
              remainingDaysSpan.className = 'remaining-days-badge';
              if (subscription.remaining_days === 0) {
                remainingDaysSpan.classList.add('remaining-days-expired');
              } else if (subscription.remaining_days <= 4) {
                remainingDaysSpan.classList.add('remaining-days-low');
              } else if (subscription.remaining_days <= 9) {
                remainingDaysSpan.classList.add('remaining-days-medium');
              } else {
                remainingDaysSpan.classList.add('remaining-days-high');
              }
              
              // Show subscription details
              subscriptionType.style.display = 'block';
              subscriptionDuration.style.display = 'block';
              subscriptionStart.style.display = 'block';
              subscriptionEnd.style.display = 'block';
              remainingDays.style.display = 'block';
              
              // Show appropriate buttons based on status
              if (subscription.remaining_days > 0) {
                if (subscription.status === 'active') {
                  pauseSubscriptionBtn.style.display = 'inline-block';
                  resumeSubscriptionBtn.style.display = 'none';
                } else if (subscription.status === 'inactive') {
                  pauseSubscriptionBtn.style.display = 'none';
                  resumeSubscriptionBtn.style.display = 'inline-block';
                }
                subscribeNowBtn.style.display = 'none';
              } else {
                pauseSubscriptionBtn.style.display = 'none';
                resumeSubscriptionBtn.style.display = 'none';
                subscribeNowBtn.style.display = 'inline-block';
              }
            } else {
              // No active subscription
              subscriptionStatus.textContent = 'No active subscription';
              subscribeNowBtn.style.display = 'inline-block';
              pauseSubscriptionBtn.style.display = 'none';
              resumeSubscriptionBtn.style.display = 'none';
            }
          })
          .catch(err => {
            console.error('Error fetching subscription details:', err);
            document.getElementById('subscriptionStatus').textContent = 'Error loading subscription';
          });
      }

      // Function to handle pause/resume subscription
      function pauseResumeSubscription(action) {
        const username = localStorage.getItem('userEmail');
        if (!username) {
          alert('User not logged in');
          return;
        }

        // Get subscription ID from the current subscription
        fetch(`/api/subscriptions/remaining/${encodeURIComponent(username)}`)
          .then(res => res.json())
          .then(data => {
            if (!data.hasActiveSubscription || !data.subscription) {
              alert('No active subscription found');
              return;
            }

            const subscription = data.subscription;
            const subscriptionId = subscription.id;
            const endpoint = `/api/subscriptions/${subscriptionId}/${action}`;
            
            if (action === 'pause') {
              // Check 5-hour delivery time constraint for pause action
              checkDeliveryTimeBeforePause(subscription, username, endpoint);
            } else {
              // For resume action, use simple confirmation
              if (confirm(`Are you sure you want to ${action} your subscription?`)) {
                executeSubscriptionAction(endpoint, username, action);
              }
            }
          })
          .catch(err => {
            console.error('Error fetching subscription:', err);
            alert('Failed to fetch subscription details');
          });
      }

      // Function to check delivery time before pausing
      function checkDeliveryTimeBeforePause(subscription, username, endpoint) {
        const modal = document.getElementById('pauseConfirmationModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const confirmBtn = document.getElementById('confirmPauseBtn');
        const cancelBtn = document.getElementById('cancelPauseBtn');
        
        // Calculate delivery time (assuming delivery is at 6 AM on the next day)
        const now = new Date();
        const deliveryTime = new Date(subscription.end_date);
        deliveryTime.setHours(6, 0, 0, 0); // Set delivery time to 6 AM
        
        // Calculate time difference in hours
        const timeDiff = deliveryTime.getTime() - now.getTime();
        const hoursDiff = timeDiff / (1000 * 60 * 60);
        
        if (hoursDiff < 5 && hoursDiff > 0) {
          // Less than 5 hours before delivery
          modalTitle.textContent = 'Cannot Pause Subscription';
          modalMessage.textContent = 'You should pause this at least 5 hours before delivery time. Please try again later.';
          confirmBtn.style.display = 'none';
          cancelBtn.textContent = 'Close';
        } else {
          // More than 5 hours before delivery
          modalTitle.textContent = 'Confirm Pause';
          modalMessage.textContent = 'Are you sure you want to pause your subscription? You can resume it anytime.';
          confirmBtn.style.display = 'inline-block';
          confirmBtn.textContent = 'Confirm';
          cancelBtn.textContent = 'Cancel';
          
          // Set up confirm button action
          confirmBtn.onclick = () => {
            modal.style.display = 'none';
            executeSubscriptionAction(endpoint, username, 'pause');
          };
        }
        
        // Set up cancel button action
        cancelBtn.onclick = () => {
          modal.style.display = 'none';
        };
        
        // Show modal
        modal.style.display = 'flex';
        
        // Close modal when clicking outside
        modal.onclick = (event) => {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        };
      }

      // Function to execute subscription action
      function executeSubscriptionAction(endpoint, username, action) {
        fetch(endpoint, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username })
        })
        .then(res => res.json())
        .then(result => {
          if (result.success) {
            alert(`Subscription ${action}d successfully`);
            fetchSubscriptionDetails(); // Refresh subscription details
          } else {
            alert(result.error || `Failed to ${action} subscription`);
          }
        })
        .catch(err => {
          console.error(`Error ${action}ing subscription:`, err);
          alert(`Failed to ${action} subscription`);
        });
      }

      // Event listeners for pause/resume buttons are already added above
    });
  </script>
</body>
</html>
