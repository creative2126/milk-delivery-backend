<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manage Subscription - Milk Delivery</title>
  <link rel="stylesheet" href="styles-new.css" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    .subscription-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin: 15px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-left: 4px solid #007bff;
    }
    
    .subscription-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .subscription-type {
      font-size: 1.2em;
      font-weight: bold;
      color: #333;
    }
    
    .subscription-status {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: bold;
    }
    
    .status-active {
      background: #d4edda;
      color: #155724;
    }
    
    .status-inactive {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-cancelled {
      background: #f5c6cb;
      color: #721c24;
    }
    
    .subscription-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    
    .detail-item {
      display: flex;
      flex-direction: column;
    }
    
    .detail-label {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 5px;
    }
    
    .detail-value {
      font-weight: bold;
      color: #333;
    }
    
    .subscription-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .action-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .pause-btn {
      background: #ffc107;
      color: #212529;
    }
    
    .resume-btn {
      background: #28a745;
      color: white;
    }
    
    .cancel-btn {
      background: #dc3545;
      color: white;
    }
    
    .action-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    
    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .empty-state h3 {
      margin-bottom: 10px;
      color: #333;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    
    .modal-title {
      margin-bottom: 15px;
      color: #333;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <!-- Header section with logo and title -->
  <header class="header-section">
    <a href="index.html" class="header-link">
      <img src="images/logo.jpg" alt="Logo" class="logo" />
      <h1>Fresh & Organic</h1>
    </a>
  </header>

  <main>
    <h1>Manage Your Subscriptions</h1>
    
    <div id="subscriptionsContainer">
      <div class="empty-state" id="emptyState">
        <h3>No subscriptions found</h3>
        <p>You don't have any active subscriptions yet.</p>
        <a href="subscription.html" class="subscribe-btn">Subscribe Now</a>
      </div>
    </div>
  </main>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="modal-overlay">
    <div class="modal-content">
      <h3 class="modal-title" id="modalTitle">Confirm Action</h3>
      <p id="modalMessage">Are you sure you want to perform this action?</p>
      <div class="modal-actions">
        <button class="action-btn" id="confirmBtn">Confirm</button>
        <button class="action-btn" id="cancelBtn" style="background: #6c757d; color: white;">Cancel</button>
      </div>
    </div>
  </div>

  <footer>
    <nav class="bottom-nav">
      <a href="index.html" class="nav-item">Home</a>
      <a href="cart.html" class="nav-item">Cart</a>
      <a href="#" class="nav-item">Offers</a>
      <a href="subscription.html" class="nav-item">Subscription</a>
      <a href="manage-subscription.html" class="nav-item active">Manage</a>
    </nav>
  </footer>

  <script src="toast.js"></script>
  <script>
    class SubscriptionManager {
      constructor() {
        this.username = localStorage.getItem('userName');
        this.subscriptions = [];
        this.init();
      }

      init() {
        if (!this.username) {
          this.showLoginRequired();
          return;
        }
        
        this.loadSubscriptions();
        this.bindEvents();
      }

      showLoginRequired() {
        const container = document.getElementById('subscriptionsContainer');
        container.innerHTML = `
          <div class="empty-state">
            <h3>Login Required</h3>
            <p>Please log in to manage your subscriptions.</p>
            <a href="login.html" class="subscribe-btn">Login</a>
          </div>
        `;
      }

      async loadSubscriptions() {
        try {
          const response = await fetch(`/api/subscriptions/user/${this.username}`);
          const data = await response.json();
          
          if (response.ok) {
            this.subscriptions = data.subscriptions;
            this.renderSubscriptions();
          } else {
            throw new Error(data.error || 'Failed to load subscriptions');
          }
        } catch (error) {
          console.error('Error loading subscriptions:', error);
          this.showError('Failed to load subscriptions. Please try again.');
        }
      }

      renderSubscriptions() {
        const container = document.getElementById('subscriptionsContainer');
        const emptyState = document.getElementById('emptyState');
        
        if (this.subscriptions.length === 0) {
          emptyState.style.display = 'block';
          return;
        }
        
        emptyState.style.display = 'none';
        
        container.innerHTML = this.subscriptions.map(sub => this.createSubscriptionCard(sub)).join('');
      }

      createSubscriptionCard(subscription) {
        const statusClass = `status-${subscription.status}`;
        const statusText = subscription.status === 'inactive' ? 'Paused' : 
                          subscription.status === 'active' ? 'Active' : 
                          subscription.status === 'cancelled' ? 'Cancelled' : 
                          subscription.status.charAt(0).toUpperCase() + subscription.status.slice(1);
        
        let actionButtons = '';
        
        if (subscription.status === 'active') {
          actionButtons = `
            <button class="action-btn pause-btn" onclick="subscriptionManager.pauseSubscription(${subscription.id})">
              Pause
            </button>
            <button class="action-btn cancel-btn" onclick="subscriptionManager.cancelSubscription(${subscription.id})">
              Cancel
            </button>
            <button class="action-btn" onclick="subscriptionManager.viewHistory(${subscription.id})" style="background: #17a2b8; color: white;">
              View History
            </button>
          `;
        } else if (subscription.status === 'inactive') {
          actionButtons = `
            <button class="action-btn resume-btn" onclick="subscriptionManager.resumeSubscription(${subscription.id})">
              Resume
            </button>
            <button class="action-btn cancel-btn" onclick="subscriptionManager.cancelSubscription(${subscription.id})">
              Cancel
            </button>
            <button class="action-btn" onclick="subscriptionManager.viewHistory(${subscription.id})" style="background: #17a2b8; color: white;">
              View History
            </button>
          `;
        }

        return `
          <div class="subscription-card">
            <div class="subscription-header">
              <div class="subscription-type">${subscription.subscription_type}</div>
              <div class="subscription-status ${statusClass}">${statusText}</div>
            </div>
            
            <div class="subscription-details">
              <div class="detail-item">
                <span class="detail-label">Duration</span>
                <span class="detail-value">${subscription.duration}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Amount</span>
                <span class="detail-value">â‚¹${subscription.amount}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Remaining Days</span>
                <span class="detail-value">${subscription.remaining_days || 'N/A'}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Start Date</span>
                <span class="detail-value">${new Date(subscription.created_at).toLocaleDateString()}</span>
              </div>
              ${subscription.end_date ? `
              <div class="detail-item">
                <span class="detail-label">End Date</span>
                <span class="detail-value">${subscription.end_date}</span>
              </div>
              ` : ''}
              ${subscription.paused_at ? `
              <div class="detail-item">
                <span class="detail-label">Paused At</span>
                <span class="detail-value">${new Date(subscription.paused_at).toLocaleDateString()}</span>
              </div>
              ` : ''}
              ${subscription.resumed_at ? `
              <div class="detail-item">
                <span class="detail-label">Resumed At</span>
                <span class="detail-value">${new Date(subscription.resumed_at).toLocaleDateString()}</span>
              </div>
              ` : ''}
              ${subscription.total_paused_days > 0 ? `
              <div class="detail-item">
                <span class="detail-label">Total Paused Days</span>
                <span class="detail-value">${subscription.total_paused_days}</span>
              </div>
              ` : ''}
            </div>
            
            <div class="subscription-actions">
              ${actionButtons}
            </div>
          </div>
        `;
      }

      showConfirmation(title, message, onConfirm) {
        const modal = document.getElementById('confirmationModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modal.style.display = 'flex';

        confirmBtn.onclick = () => {
          modal.style.display = 'none';
          onConfirm();
        };

        cancelBtn.onclick = () => {
          modal.style.display = 'none';
        };
      }

      async pauseSubscription(id) {
        this.showConfirmation(
          'Pause Subscription',
          'Are you sure you want to pause this subscription? You can resume it anytime.',
          async () => {
            try {
              console.log('Pausing subscription ID:', id);
              const response = await fetch(`/api/subscriptions/${id}/pause`, {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username: this.username })
              });

              const data = await response.json();
              console.log('Pause response:', data);
              
              if (response.ok) {
                window.toast.show('Subscription paused successfully', 'success');
                this.loadSubscriptions();
              } else {
                window.toast.show(data.error || 'Failed to pause subscription', 'error');
              }
            } catch (error) {
              console.error('Error pausing subscription:', error);
              window.toast.show('Failed to pause subscription', 'error');
            }
          }
        );
      }

      async resumeSubscription(id) {
        this.showConfirmation(
          'Resume Subscription',
          'Are you sure you want to resume this subscription?',
          async () => {
            try {
              const response = await fetch(`/api/subscriptions/${id}/resume`, {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username: this.username })
              });

              const data = await response.json();
              
              if (response.ok) {
                window.toast.show('Subscription resumed successfully', 'success');
                this.loadSubscriptions();
              } else {
                window.toast.show(data.error || 'Failed to resume subscription', 'error');
              }
            } catch (error) {
              console.error('Error resuming subscription:', error);
              window.toast.show('Failed to resume subscription', 'error');
            }
          }
        );
      }

      async cancelSubscription(id) {
        this.showConfirmation(
          'Cancel Subscription',
          'Are you sure you want to cancel this subscription? This action cannot be undone.',
          async () => {
            try {
              const response = await fetch(`/api/subscriptions/${id}/cancel`, {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username: this.username })
              });

              const data = await response.json();
              
              if (response.ok) {
                window.toast.show('Subscription cancelled successfully', 'success');
                this.loadSubscriptions();
              } else {
                window.toast.show(data.error || 'Failed to cancel subscription', 'error');
              }
            } catch (error) {
              console.error('Error cancelling subscription:', error);
              window.toast.show('Failed to cancel subscription', 'error');
            }
          }
        );
      }

      showError(message) {
        const container = document.getElementById('subscriptionsContainer');
        container.innerHTML = `
          <div class="empty-state">
            <h3>Error</h3>
            <p>${message}</p>
            <button onclick="subscriptionManager.loadSubscriptions()" class="subscribe-btn">Retry</button>
          </div>
        `;
      }

      bindEvents() {
        // Close modal when clicking outside
        const modal = document.getElementById('confirmationModal');
        window.onclick = (event) => {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        };
      }
    }

    // Initialize subscription manager
    const subscriptionManager = new SubscriptionManager();
  </script>
</body>
</html>
